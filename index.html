<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ant0wan's Cheatsheets</title>

  <!-- Satoshi Font -->
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet">

  <!-- PrismJS Theme -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Satoshi', sans-serif;
      background-color: #000000;
      color: #d7d2cb;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    h2 {
      font-size: 20px;
      margin: 0 0 10px 0;
    }

    a {
      color: #E2725B;
      text-decoration: none;
    }

    .gist {
      background: #0d0c0b;
      padding: 20px;
      margin-bottom: 40px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .files {
      font-size: 13px;
      margin-bottom: 15px;
      color: #888;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }

    .file-item {
      display: flex;
      align-items: center;
      background: rgba(215, 210, 203, 0.08);
      padding: 4px 8px;
      border-radius: 3px;
      font-family: monospace;
    }

    .file-date {
      color: #d7d2cb;
    }

    pre,
    .gist pre,
    .markdown-content pre {
      background-color: #0d0c0b !important;
      padding: 0;
      margin: 0;
      overflow-x: auto;
    }

    code,
    .gist code,
    .markdown-content code {
      font-size: 14px;
      font-family: monospace;
      background-color: #0d0c0b !important;
      padding: 0;
      margin: 0;
    }

    pre code {
      display: block;
      padding: 15px;
    }

    .loading {
      text-align: center;
      font-size: 18px;
      margin-top: 50px;
      color: #888;
    }

    #index {
      margin-bottom: 40px;
      padding: 20px;
      background: #0d0c0b;
      border-radius: 4px;
    }

    #index h2 {
      margin-top: 0;
      font-size: 18px;
    }

    #index-list {
      list-style: none;
      padding-left: 0;
      line-height: 1.8;
      margin: 0;
    }

    #index-list a:hover {
      text-decoration: underline;
    }

    .svg-container {
      background: white;
      padding: 10px;
      margin-top: 10px;
      text-align: center;
      border-radius: 4px;
    }

    .svg-container img {
      max-width: 100%;
      height: auto;
      max-height: 300px;
    }

    .markdown-content {
      background: #0d0c0b;
      padding: 0;
    }

    .markdown-content > * {
      padding: 0 20px;
    }

    .markdown-content > pre {
      padding: 15px !important;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
    }

    .markdown-content p {
      margin: 1em 0;
      line-height: 1.6;
    }

    .markdown-content ul,
    .markdown-content ol {
      margin: 1em 0;
      padding-left: 2em;
    }

    .markdown-content a {
      color: #E2725B;
    }

    .error {
      background: #1a1a1a;
      padding: 20px;
      border-left: 4px solid #E2725B;
      border-radius: 4px;
    }

    .error ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .progress {
      text-align: center;
      margin: 20px 0;
      color: #888;
    }
  </style>
</head>
<body>
  <h1>Cheatsheets</h1>

  <div id="index">
    <h2>Topics</h2>
    <ul id="index-list">
      <li>Loading index...</li>
    </ul>
  </div>

  <div id="gist-container">
    <div class="loading">Loading gists...</div>
  </div>

  <!-- PrismJS Core & Language Support -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>

  <script>
    const username = "Ant0wan";
    const perPage = 100; // Max allowed by GitHub API

    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 8000 } = options;

      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);

      const response = await fetch(resource, {
        ...options,
        signal: controller.signal
      });
      clearTimeout(id);

      return response;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    async function fetchAllGists() {
      let allGists = [];
      let page = 1;
      let hasMore = true;
      let error = null;

      while (hasMore) {
        try {
          const response = await fetchWithTimeout(
            `https://api.github.com/users/${username}/gists?per_page=${perPage}&page=${page}`,
            {
              headers: {
                'Accept': 'application/vnd.github.v3+json'
              }
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const gists = await response.json();
          allGists = [...allGists, ...gists];

          // Update loading progress
          const progress = document.getElementById('loading-progress');
          if (progress) {
            progress.textContent = `Loaded ${allGists.length} gists...`;
          }

          // Check pagination
          const linkHeader = response.headers.get('Link');
          hasMore = linkHeader && linkHeader.includes('rel="next"');
          page++;

        } catch (err) {
          console.error(`Error fetching gists page ${page}:`, err);
          error = err;
          hasMore = false;
        }
      }

      if (error && allGists.length === 0) {
        throw error;
      }

      return allGists;
    }

    async function fetchGists() {
      const container = document.getElementById('gist-container');
      const indexList = document.getElementById('index-list');

      try {
        container.innerHTML = `
          <div class="loading">
            <p>Loading gists (this may take a moment)...</p>
            <p id="loading-progress" class="progress">Starting...</p>
          </div>
        `;

        const gists = await fetchAllGists();

        if (gists.length === 0) {
          container.innerHTML = '<p>No gists found for this user.</p>';
          indexList.innerHTML = '<li>No public gists available</li>';
          return;
        }

        container.innerHTML = '';
        indexList.innerHTML = '';

        // Process and display gists
        for (let i = 0; i < gists.length; i++) {
          const gist = gists[i];
          const gistId = `gist-${i}`;
          const title = gist.description || `Gist ${i + 1}`;
          const fileList = Object.values(gist.files);
          const firstFile = fileList[0];
          const language = (firstFile.language || 'text').toLowerCase();
          const isSvg = firstFile.filename.toLowerCase().endsWith('.svg');
          const isMd = firstFile.filename.toLowerCase().endsWith('.md');
          const createdAt = formatDate(gist.created_at);

          // Add to index
          const li = document.createElement('li');
          li.innerHTML = `<a href="#${gistId}">${title}</a>`;
          indexList.appendChild(li);

          // Gist block
          const gistDiv = document.createElement('div');
          gistDiv.className = 'gist';
          gistDiv.id = gistId;

          // Create files container
          const filesContainer = document.createElement('div');
          filesContainer.className = 'files';
          
          // Add creation date for each file
          Object.keys(gist.files).forEach(() => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
              <span class="file-date">${createdAt}</span>
            `;
            filesContainer.appendChild(fileItem);
          });

          gistDiv.innerHTML = `
            <h2><a href="${gist.html_url}" target="_blank">${title}</a></h2>
          `;
          
          // Append the files container
          gistDiv.appendChild(filesContainer);

          if (firstFile && firstFile.raw_url) {
            try {
              if (isSvg) {
                gistDiv.innerHTML += `
                  <div class="svg-container">
                    <img src="${firstFile.raw_url}" alt="${firstFile.filename}">
                  </div>
                `;
              } else if (isMd) {
                const fileRes = await fetchWithTimeout(firstFile.raw_url);
                const markdown = await fileRes.text();
                gistDiv.innerHTML += `
                  <div class="markdown-content">
                    ${marked.parse(markdown)}
                  </div>
                `;
              } else {
                const fileRes = await fetchWithTimeout(firstFile.raw_url);
                const code = await fileRes.text();
                gistDiv.innerHTML += `
                  <pre><code class="language-${language}">${escapeHtml(code)}</code></pre>
                `;
              }
            } catch (e) {
              console.error(`Error loading file ${firstFile.filename}:`, e);
              gistDiv.innerHTML += `<p>Could not load file preview.</p>`;
            }
          }

          container.appendChild(gistDiv);
        }

        Prism.highlightAll();

      } catch (error) {
        console.error('Failed to load gists:', error);
        container.innerHTML = `
          <div class="error">
            <p>Failed to load gists. Possible reasons:</p>
            <ul>
              <li>GitHub API rate limit exceeded (try again later)</li>
              <li>Network connectivity issues</li>
              <li>User "${username}" doesn't exist or has no public gists</li>
            </ul>
            <p>Try refreshing the page or check the console for details.</p>
          </div>
        `;
        indexList.innerHTML = '<li>Error loading index</li>';
      }
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    fetchGists();
  </script>
</body>
</html>
